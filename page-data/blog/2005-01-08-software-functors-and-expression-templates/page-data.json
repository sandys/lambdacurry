{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2005-01-08-software-functors-and-expression-templates/","result":{"data":{"site":{"siteMetadata":{"title":"Lambdacurry"}},"markdownRemark":{"id":"c566b7ef-917b-5339-81f6-e3a4cda59d46","excerpt":"Consider a scenario in which, given a graph, you have to traverse it. How do you do it - write a function. Now consider a situation, in which only those nodes…","html":"<p>Consider a scenario in which, given a graph, you have to traverse it. How do you do it - write a function. Now consider a situation, in which only those nodes of a graph have to be touched which have a weight of say 8. Again, very simple - just pass an argument to the function (of value 8). But what if, the function is actually a callback. That is, the function is passed to another function. In such cases, it becomes difficult in terms of maintainability and performance (more on that later). Now, if you could somehow create a function with state, the above becomes so much easier. Enter functors… Functors are also frequently better performing than functions.</p>\n<blockquote>\n<p>Stroustrup says: “A suitably-defined object serves as well as - and often better than - a function. For example, it is easier to inline the application operator of a class than to inline a function passed as a pointer to a function. Consequently, function objects often execute faster than do ordinary functions.” Stroustrup, TC++PL (3d. ed.), Sec. 18.4, p. 515.</p>\n</blockquote>\n<p>Functors can also be used in recursion. It took me a while to figure out the correct syntax to do this:</p>\n<p>class sssFactorial{\nint operator() (int val){\nif(val==1) return val;\nelse return (val*this->operator()(val-1));\n}\n};</p>\n<p>This is well and good, but as we can see it is not exactly very trivial to construct functors as compared to plain vanilla functions (writing those extra lines will put a strain on your poor fingers). There are two ways of handling this - generating functors by using:</p>\n<ol>\n<li>Functor binding</li>\n<li>Expression templates</li>\n</ol>\n<p>Functor binding essentially binds a binary functor (which takes 2 arguments) into a unary functor (which takes one argument). How is this good you ask - how can reducing the degrees of freedom be any good, right? Wrong. Binding may reduce degrees of freedom, but it makes a new functor from an old one. Suppose you were given two functors prod (to find the product of two parameters), div (to find quotient of two parameters)- how would you make a functor that creates (x*b)/c f=bind1st(bind1st(div(),b),c) ; Now, f(x)=(x*b)/c</p>\n<p>(The C++ Standard Library also has the compose functor which is powerful still) Expression templates is a C++ technique for passing expressions as function arguments. A compliant compiler would be able to inline all the expressions (without the need for temporary variables), thereby speeding up code.</p>\n<p>Expression templates are one of the most powerful features available in C++. Consider a matrix or vector operation of the form</p>\n<blockquote>\n<p>X=Z*Y + Y, Where X,Y ans Z are matrices.</p>\n</blockquote>\n<p>In this case, at each step of the computation of the mathematical expression, temporaries are created, each of which is of matrix size, which hogs the available memory. However, it is possible to decompose this complex operation into mathematical expression involving primitive ints/floats (i.e. actually determining the matrix formula for calculating each element of the resultant matrix). This is good, very good…but..not very maintainable (the horror..the horror) Enter expression templates. Expression templates allows the compiler to generate a compile time tree of expressions. No more trying to write large expressions, the compiler does it for you. Along with inlining most of the functions/functors used - producing faster code. For a valid, compilable code - see below…way below. For example several high performance libraries for matrix operations use expression templates (for example, <a href=\"http://met.sourceforge.net/\">MET</a> ). Expression Templates are a great way to calculate matrices, with great performance.</p>\n<p>In EDA, matrixes are used for simulation, for functional verification, petri nets and hundreds of other applications. Cool..or what!!</p>\n<p>Code for a sample expression template - just gives value of x*4</p>\n<p>#include <iostream></p>\n<p>#include &#x3C;stdio.h>\nusing namespace std;</p>\n<p>template<class A>\nclass Expr{</p>\n<p>public:\nExpr(const A&#x26; a):_a(a){}<br>\n//needed for variable\nExpr(){}<br>\nint operator() (int x){\nreturn _a(x);\n}<br>\nint getVal(){return _a;}</p>\n<p>private :\nA _a;\n};</p>\n<p>class Variable{\n//no constructor needed, since this is a variable\npublic: int operator() (int x){ return x;}\n};</p>\n<p>class Constant{\npublic:\nConstant(int a):_con(a){}\nint operator() (int a){return _con;}</p>\n<p>private:\nint _con;\n};</p>\n<p>template &#x3C;class A, class B, class Oper></p>\n<p>class BinaryExpression{\npublic:\nBinaryExpression(const A&#x26; a, const B&#x26;b): _a(a),_b(b){}\n// The functor calls a static inline function</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">  int operator() (int x) {\n       return Oper::apply(\\_a(x), \\_b(x)) ;\n  //remember \\_a and \\_b need not be constants, they may be expressions.\n  }</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>private:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">  A \\_a;\n  B \\_b;</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>};</p>\n<p>class Multiplier{\npublic:Multiplier(){}\nstatic inline int apply(int a, int b){\nreturn a*b;\n}\n};</p>\n<p>template <class A>\nExpr &#x3C;BinaryExpression&#x3C;Expr<A>, Constant, Multiplier> >\noperator* (const Expr <A> &#x26; e, int val){\n//The most important line. This creates BinaryExpression object,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">  //wraps it in a Expr and returns it.\n  //While doing so, it wraps the constant operand in a &quot;Constant&quot; object.\n  //The Multiplier functor is passed to BinaryExpression for evaluation.\n  return Expr &lt;BinaryExpression&lt; Expr&lt;A&gt;, Constant, Multiplier&gt; &gt; \n       ( BinaryExpression&lt;Expr&lt;A&gt;, Constant, Multiplier &gt; (e,Constant(val)) );</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>}</p>\n<p>//the evaluation function.\ntemplate <class anything>\nint evaluate(Expr<anything> e, int val){\ncout&#x3C;&#x3C;e(val)&#x3C;&#x3C;endl;\n}</p>\n<p>int main(){\n//We create a variable and use it.\nExpr <Variable> x;\nevaluate(x*4, 5);\n}</p>\n<p>del.icio.us Tags: <a href=\"http://del.icio.us/sss8ue/software\">software</a> <a href=\"http://del.icio.us/sss8ue/c++\">c++</a> <a href=\"http://del.icio.us/sss8ue/g++\">g++</a> <a href=\"http://del.icio.us/sss8ue/compiler\">compiler</a> <a href=\"http://del.icio.us/sss8ue/functor\">functor</a></p>","frontmatter":{"title":"[Software] Functors and expression templates","date":"January 08, 2005"}}},"pageContext":{"slug":"/blog/2005-01-08-software-functors-and-expression-templates/","previous":{"fields":{"slug":"/blog/2005-01-08-business-stanford-edcorner/"},"frontmatter":{"title":"[Business] Stanford Edcorner"}},"next":{"fields":{"slug":"/blog/2005-01-10-business-software-developers-open-source-and-complements/"},"frontmatter":{"title":"[Business, Software] Developers, Open Source and Complements"}}}},"staticQueryHashes":["2778469899","2841359383","2882394463","3616023293"]}